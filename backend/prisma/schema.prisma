// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Auth & Users
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  expenses      Expense[]
  journalEntries JournalEntry[]
}

// Accounting: Chart of Accounts
model Account {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  type          String   // asset, liability, equity, revenue, expense
  subType       String?
  normalBalance String   // debit, credit
  isActive      Boolean  @default(true)
  balance       Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  journalDebits  JournalLine[] @relation("DebitAccount")
  journalCredits JournalLine[] @relation("CreditAccount")
  expenses       Expense[]
}

// Accounting: Journal Entries
model JournalEntry {
  id            String   @id @default(uuid())
  journalNumber String   @unique
  entryDate     DateTime
  reference     String?
  description   String?
  totalDebit    Float
  totalCredit   Float
  status        String   @default("draft") // draft, posted
  createdBy     String
  user          User     @relation(fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lines         JournalLine[]
}

model JournalLine {
  id             String       @id @default(uuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  debitAccountId String?
  debitAccount   Account?     @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccountId String?
  creditAccount  Account?     @relation("CreditAccount", fields: [creditAccountId], references: [id])
  amount         Float
  description    String?
}

// Accounting: Expenses
model Expense {
  id            String   @id @default(uuid())
  expenseNumber String   @unique
  expenseDate   DateTime
  category      String
  description   String
  amount        Float
  paymentMethod String
  status        String   @default("pending") // pending, approved, rejected
  accountId     String?
  account       Account? @relation(fields: [accountId], references: [id])
  approvedBy    String?
  user          User?    @relation(fields: [approvedBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Accounting: Fixed Assets
model FixedAsset {
  id                      String   @id @default(uuid())
  assetNumber             String   @unique
  name                    String
  category                String
  purchaseDate            DateTime
  purchasePrice           Float
  salvageValue            Float
  usefulLife              Int      // in months
  depreciationMethod      String   // straight_line, etc.
  accumulatedDepreciation Float    @default(0)
  currentValue            Float
  status                  String   @default("active")
  location                String?
  serialNumber            String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Accounting: Budgets
model Budget {
  id             String   @id @default(uuid())
  fiscalYear     String
  department     String
  category       String
  budgetedAmount Float
  actualAmount   Float    @default(0)
  startDate      DateTime
  endDate        DateTime
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Accounting: Bank Accounts
model BankAccount {
  id             String   @id @default(uuid())
  accountName    String
  accountNumber  String
  bankName       String
  accountType    String   // checking, savings
  currency       String   @default("USD")
  openingBalance Float
  currentBalance Float
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// CRM: Contacts
model Contact {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  email       String?
  phone       String?
  company     String?
  status      String   @default("lead")
  source      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  deals       Deal[]
  activities  Activity[]
}

// CRM: Deals (Opportunities)
model Deal {
  id          String   @id @default(uuid())
  name        String
  value       Float
  stage       String
  probability Int      @default(0)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  expectedCloseDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  pipelineId  String?
  pipeline    Pipeline? @relation(fields: [pipelineId], references: [id])
}

// CRM: Leads (distinct from Contacts in this system)
model Lead {
  id          String   @id @default(uuid())
  name        String
  company     String?
  email       String?
  phone       String?
  source      String?
  status      String   @default("new")
  score       Int      @default(0)
  assignedTo  String?
  notes       String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastContact DateTime?
}

// CRM: Pipelines
model Pipeline {
  id          String   @id @default(uuid())
  name        String
  stages      String[]
  deals       Deal[]
}

// CRM: Activities
model Activity {
  id          String   @id @default(uuid())
  type        String   // call, email, meeting
  subject     String
  dueDate     DateTime?
  status      String   @default("pending") // pending, completed
  relatedTo   String?
  notes       String?
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== ENHANCED ACCOUNTING MODELS ====================

// Credit Notes (Customer Returns/Adjustments)
model CreditNote {
  id                String   @id @default(uuid())
  creditNoteNumber  String   @unique
  customerId        String
  invoiceId         String?  // Original invoice if applicable
  issueDate         DateTime
  reason            String
  subtotal          Float
  taxAmount         Float    @default(0)
  totalAmount       Float
  status            String   @default("draft") // draft, issued, applied, void
  appliedAmount     Float    @default(0)
  notes             String?
  createdBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items             CreditNoteItem[]
}

model CreditNoteItem {
  id              String     @id @default(uuid())
  creditNoteId    String
  creditNote      CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  productId       String?
  description     String
  quantity        Float
  unitPrice       Float
  taxRate         Float      @default(0)
  total           Float
}

// Debit Notes (Vendor Returns/Adjustments)
model DebitNote {
  id               String   @id @default(uuid())
  debitNoteNumber  String   @unique
  vendorId         String
  billId           String?  // Original bill if applicable
  issueDate        DateTime
  reason           String
  subtotal         Float
  taxAmount        Float    @default(0)
  totalAmount      Float
  status           String   @default("draft") // draft, issued, applied, void
  appliedAmount    Float    @default(0)
  notes            String?
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            DebitNoteItem[]
}

model DebitNoteItem {
  id            String    @id @default(uuid())
  debitNoteId   String
  debitNote     DebitNote @relation(fields: [debitNoteId], references: [id], onDelete: Cascade)
  productId     String?
  description   String
  quantity      Float
  unitPrice     Float
  taxRate       Float     @default(0)
  total         Float
}

// Bills (Vendor Invoices / Purchase Invoices)
model Bill {
  id              String   @id @default(uuid())
  billNumber      String   @unique
  vendorId        String
  purchaseOrderId String?
  grnId           String?
  billDate        DateTime
  dueDate         DateTime
  subtotal        Float
  taxAmount       Float    @default(0)
  discountAmount  Float    @default(0)
  totalAmount     Float
  paidAmount      Float    @default(0)
  balance         Float
  status          String   @default("draft") // draft, pending, partial, paid, void
  paymentTerms    String?
  notes           String?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           BillItem[]
  payments        BillPayment[]
}

model BillItem {
  id          String  @id @default(uuid())
  billId      String
  bill        Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)
  productId   String?
  description String
  quantity    Float
  unitPrice   Float
  taxRate     Float   @default(0)
  discount    Float   @default(0)
  total       Float
}

// Payments Received (from Customers)
model Payment {
  id              String   @id @default(uuid())
  paymentNumber   String   @unique
  customerId      String
  paymentDate     DateTime
  amount          Float
  paymentMode     String   // cash, bank_transfer, upi, card, cheque
  referenceNumber String?
  bankAccountId   String?
  depositTo       String?  // Account ID where money is deposited
  notes           String?
  status          String   @default("received") // received, deposited, void
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  applications    PaymentApplication[]
}

model PaymentApplication {
  id          String  @id @default(uuid())
  paymentId   String
  payment     Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoiceId   String
  amount      Float
  appliedAt   DateTime @default(now())
}

// Payments Made (to Vendors)
model BillPayment {
  id              String   @id @default(uuid())
  paymentNumber   String   @unique
  vendorId        String
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id])
  paymentDate     DateTime
  amount          Float
  paymentMode     String
  referenceNumber String?
  bankAccountId   String?
  paidFrom        String?  // Account ID where money is paid from
  notes           String?
  status          String   @default("paid") // paid, void
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Receipts (Money Received - alternate to Payment for simpler tracking)
model Receipt {
  id              String   @id @default(uuid())
  receiptNumber   String   @unique
  receiptDate     DateTime
  receivedFrom    String   // Customer name or ID
  amount          Float
  paymentMode     String
  referenceNumber String?
  bankAccountId   String?
  accountId       String?  // Income/Revenue account
  description     String?
  status          String   @default("received")
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Stock Journal (Inventory Adjustments)
model StockJournal {
  id              String   @id @default(uuid())
  journalNumber   String   @unique
  journalDate     DateTime
  journalType     String   // adjustment, transfer, write_off, opening
  warehouseFromId String?
  warehouseToId   String?
  reason          String
  reference       String?
  status          String   @default("draft") // draft, posted
  totalValue      Float    @default(0)
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           StockJournalItem[]
}

model StockJournalItem {
  id              String       @id @default(uuid())
  stockJournalId  String
  stockJournal    StockJournal @relation(fields: [stockJournalId], references: [id], onDelete: Cascade)
  productId       String
  quantityIn      Float        @default(0)
  quantityOut     Float        @default(0)
  unitCost        Float
  totalValue      Float
  batchNumber     String?
  serialNumbers   String[]
  notes           String?
}

// Voucher Number Series (Auto-numbering like Tally)
model VoucherNumber {
  id          String   @id @default(uuid())
  voucherType String   @unique // invoice, credit_note, debit_note, payment, receipt, journal, bill, purchase_order, grn
  prefix      String
  separator   String   @default("/")
  fiscalYear  String   // e.g., "2025-26"
  nextNumber  Int      @default(1)
  format      String   @default("{prefix}{separator}{fiscalYear}{separator}{number}") // Template
  padding     Int      @default(4) // Zero-padding for number
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([voucherType, fiscalYear])
}

// Webhooks (for external integrations like QuickBooks)
model Webhook {
  id          String   @id @default(uuid())
  name        String
  event       String   // invoice.created, payment.received, bill.created, etc.
  targetUrl   String
  secret      String   // For HMAC signature verification
  headers     Json?    // Custom headers to send
  isActive    Boolean  @default(true)
  retryCount  Int      @default(3)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  logs        WebhookLog[]
}

model WebhookLog {
  id          String   @id @default(uuid())
  webhookId   String
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event       String
  payload     Json
  response    String?
  statusCode  Int?
  success     Boolean  @default(false)
  errorMessage String?
  sentAt      DateTime @default(now())
  duration    Int?     // Response time in ms
}

// Audit Log (for compliance)
model AuditLog {
  id          String   @id @default(uuid())
  action      String   // create, update, delete, post, void
  entity      String   // invoice, bill, journal, etc.
  entityId    String
  userId      String?
  userName    String?
  changes     Json?    // Before/after values
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

